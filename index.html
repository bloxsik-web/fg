<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireGuild - –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        body { background: #0b141a; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        
        /* Auth Screen */
        .auth-screen { width: 100%; max-width: 400px; background: #1f2c33; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .auth-screen h2 { color: white; text-align: center; margin-bottom: 30px; background: linear-gradient(45deg, #8774e1, #c85b9c); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .auth-tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .auth-tab { flex: 1; padding: 10px; background: #2a3943; border: none; color: #8696a0; cursor: pointer; border-radius: 10px; }
        .auth-tab.active { background: #8774e1; color: white; }
        .auth-form input { width: 100%; padding: 12px; margin: 10px 0; background: #2a3943; border: none; border-radius: 10px; color: white; outline: none; }
        .auth-form button { width: 100%; padding: 12px; background: #8774e1; border: none; border-radius: 10px; color: white; font-weight: bold; cursor: pointer; }
        
        /* Main App */
        .app { width: 100%; max-width: 1200px; height: 90vh; background: #1f2c33; border-radius: 20px; display: flex; overflow: hidden; }
        
        /* Sidebar */
        .sidebar { width: 300px; background: #202b33; border-right: 1px solid #2a3943; display: flex; flex-direction: column; }
        .user-profile { padding: 20px; border-bottom: 1px solid #2a3943; }
        .user-profile h3 { color: white; margin-bottom: 5px; }
        .user-profile p { color: #8696a0; font-size: 0.8rem; }
        .logout-btn { margin-top: 10px; padding: 5px; background: #f56565; border: none; border-radius: 5px; color: white; cursor: pointer; font-size: 0.8rem; }
        
        /* Tabs */
        .tabs { display: flex; padding: 10px; gap: 5px; }
        .tab { flex: 1; padding: 8px; background: #2a3943; border: none; color: #8696a0; cursor: pointer; border-radius: 5px; }
        .tab.active { background: #8774e1; color: white; }
        
        /* Lists */
        .list-container { flex: 1; overflow-y: auto; padding: 10px; }
        .list-item { display: flex; align-items: center; padding: 10px; margin: 5px 0; background: #2a3943; border-radius: 10px; cursor: pointer; }
        .list-item:hover { background: #3a4a55; }
        .list-item.active { background: #8774e1; }
        .avatar { width: 40px; height: 40px; background: #8774e1; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; margin-right: 10px; }
        .item-info { flex: 1; }
        .item-name { color: white; font-weight: 500; }
        .item-status { font-size: 0.7rem; color: #48bb78; }
        
        /* Add Friend */
        .add-friend { padding: 10px; border-bottom: 1px solid #2a3943; }
        .add-friend input { width: 100%; padding: 8px; background: #2a3943; border: none; border-radius: 5px; color: white; margin-bottom: 5px; }
        .add-friend button { width: 100%; padding: 8px; background: #48bb78; border: none; border-radius: 5px; color: white; cursor: pointer; }
        
        /* Chat Area */
        .chat-area { flex: 1; display: flex; flex-direction: column; }
        .chat-header { padding: 20px; background: #202b33; border-bottom: 1px solid #2a3943; color: white; display: flex; align-items: center; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 15px; word-break: break-word; }
        .my-message { align-self: flex-end; background: #8774e1; color: white; border-bottom-right-radius: 5px; }
        .other-message { align-self: flex-start; background: #2a3943; color: white; border-bottom-left-radius: 5px; }
        .message-image { max-width: 200px; max-height: 200px; border-radius: 10px; cursor: pointer; }
        .message-info { font-size: 0.7rem; opacity: 0.7; margin-bottom: 3px; display: flex; justify-content: space-between; }
        .input-area { padding: 20px; background: #202b33; display: flex; gap: 10px; align-items: center; }
        .input-area input { flex: 1; padding: 12px; background: #2a3943; border: none; border-radius: 25px; color: white; outline: none; }
        .plus-btn { width: 45px; height: 45px; background: #8774e1; border: none; border-radius: 50%; color: white; font-size: 1.5rem; cursor: pointer; }
        .send-btn { width: 45px; height: 45px; background: #48bb78; border: none; border-radius: 50%; color: white; font-size: 1.2rem; cursor: pointer; }
        
        /* Modal */
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; display: none; }
        .modal-content { background: #1f2c33; padding: 20px; border-radius: 10px; max-width: 500px; max-height: 80vh; overflow: auto; }
        .modal-image { max-width: 100%; max-height: 70vh; }
        .friend-request { background: #2a3943; padding: 15px; border-radius: 10px; margin: 10px 0; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div class="auth-screen" id="authScreen">
        <h2>üî• FireGuild</h2>
        <div class="auth-tabs">
            <button class="auth-tab active" id="loginTab">–í—Ö–æ–¥</button>
            <button class="auth-tab" id="registerTab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        
        <!-- Login Form -->
        <div class="auth-form" id="loginForm">
            <input type="text" id="loginUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="loginBtn">–í–æ–π—Ç–∏</button>
        </div>
        
        <!-- Register Form -->
        <div class="auth-form" id="registerForm" style="display: none;">
            <input type="text" id="regUsername" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å">
            <input type="text" id="regDisplayName" placeholder="–û—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–µ –∏–º—è">
            <button id="registerBtn">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
        </div>
    </div>

    <!-- Main App -->
    <div class="app" id="app" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="user-profile" id="userProfile">
                <h3 id="displayName">–ó–∞–≥—Ä—É–∑–∫–∞...</h3>
                <p id="userLogin">@username</p>
                <button class="logout-btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
            </div>
            
            <div class="tabs">
                <button class="tab active" id="chatsTab">–ß–∞—Ç—ã</button>
                <button class="tab" id="friendsTab">–î—Ä—É–∑—å—è</button>
            </div>
            
            <!-- Add Friend -->
            <div class="add-friend">
                <input type="text" id="friendUsername" placeholder="–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –¥—Ä—É–≥–∞">
                <button id="addFriendBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞</button>
            </div>
            
            <!-- Lists Container -->
            <div class="list-container" id="chatsList">
                <!-- –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
            
            <div class="list-container" id="friendsList" style="display: none;">
                <!-- –°–ø–∏—Å–æ–∫ –¥—Ä—É–∑–µ–π –±—É–¥–µ—Ç –∑–¥–µ—Å—å -->
            </div>
        </div>
        
        <!-- Chat Area -->
        <div class="chat-area">
            <div class="chat-header" id="chatHeader">
                –í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç
            </div>
            
            <div class="messages" id="messages"></div>
            
            <div class="input-area" id="chatInput" style="display: none;">
                <button class="plus-btn" id="imageBtn">+</button>
                <input type="text" id="messageInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
                <button class="send-btn" id="sendBtn">‚û§</button>
                <input type="file" id="imageInput" accept="image/*" style="display: none;">
            </div>
        </div>
    </div>
    
    <!-- Image Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <img src="" alt="Preview" class="modal-image" id="modalImage">
            <button style="margin-top: 10px; padding: 8px; background: #8774e1; border: none; border-radius: 5px; color: white; cursor: pointer;" id="closeModal">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, query, orderByChild, get, update, remove, onChildAdded } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";
        import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-storage.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDxTZxpBF6ma0m3FLbxQhxD_xngu0Nm6OU",
            authDomain: "fireguildnew-3356a.firebaseapp.com",
            databaseURL: "https://fireguildnew-3356a-default-rtdb.firebaseio.com",
            projectId: "fireguildnew-3356a",
            storageBucket: "fireguildnew-3356a.firebasestorage.app",
            messagingSenderId: "1020153656700",
            appId: "1:1020153656700:web:9a39087a47b8c4138aa0f9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const storage = getStorage(app);

        // –≠–ª–µ–º–µ–Ω—Ç—ã
        const authScreen = document.getElementById('authScreen');
        const mainApp = document.getElementById('app');
        const loginTab = document.getElementById('loginTab');
        const registerTab = document.getElementById('registerTab');
        const loginForm = document.getElementById('loginForm');
        const registerForm = document.getElementById('registerForm');
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const chatsTab = document.getElementById('chatsTab');
        const friendsTab = document.getElementById('friendsTab');
        const chatsList = document.getElementById('chatsList');
        const friendsList = document.getElementById('friendsList');
        const addFriendBtn = document.getElementById('addFriendBtn');
        const friendUsername = document.getElementById('friendUsername');
        const messagesDiv = document.getElementById('messages');
        const chatHeader = document.getElementById('chatHeader');
        const chatInput = document.getElementById('chatInput');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const imageBtn = document.getElementById('imageBtn');
        const imageInput = document.getElementById('imageInput');
        const imageModal = document.getElementById('imageModal');
        const modalImage = document.getElementById('modalImage');
        const closeModal = document.getElementById('closeModal');
        
        let currentUser = null;
        let currentChat = null;

        // üî• –ü–†–û–í–ï–†–ö–ê –°–û–•–†–ê–ù–ï–ù–ù–û–ô –°–ï–°–°–ò–ò
        const savedUser = localStorage.getItem('fireguild_user');
        if (savedUser) {
            try {
                currentUser = JSON.parse(savedUser);
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –±–∞–∑–µ
                get(ref(db, `users/${currentUser.username}`)).then((snapshot) => {
                    if (snapshot.exists()) {
                        authScreen.style.display = 'none';
                        mainApp.style.display = 'flex';
                        document.getElementById('displayName').textContent = currentUser.displayName;
                        document.getElementById('userLogin').textContent = '@' + currentUser.username;
                        loadData();
                    } else {
                        // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ - –æ—á–∏—â–∞–µ–º localStorage
                        localStorage.removeItem('fireguild_user');
                    }
                });
            } catch (e) {
                localStorage.removeItem('fireguild_user');
            }
        }

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        loginTab.onclick = () => {
            loginTab.classList.add('active');
            registerTab.classList.remove('active');
            loginForm.style.display = 'block';
            registerForm.style.display = 'none';
        };
        
        registerTab.onclick = () => {
            registerTab.classList.add('active');
            loginTab.classList.remove('active');
            registerForm.style.display = 'block';
            loginForm.style.display = 'none';
        };

        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
        registerBtn.onclick = async () => {
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value;
            const displayName = document.getElementById('regDisplayName').value.trim();
            
            if (!username || !password || !displayName) {
                alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }
            
            const userRef = ref(db, `users/${username}`);
            const snapshot = await get(userRef);
            
            if (snapshot.exists()) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!');
                return;
            }
            
            await set(userRef, {
                password: password,
                displayName: displayName,
                friends: {},
                friendRequests: {},
                chats: {}
            });
            
            alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.');
            loginTab.click();
        };

        // –í—Ö–æ–¥
        loginBtn.onclick = async () => {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            const userRef = ref(db, `users/${username}`);
            const snapshot = await get(userRef);
            
            if (!snapshot.exists()) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            
            const userData = snapshot.val();
            if (userData.password !== password) {
                alert('–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!');
                return;
            }
            
            currentUser = {
                username: username,
                displayName: userData.displayName
            };
            
            // üî• –°–û–•–†–ê–ù–Ø–ï–ú –í LOCALSTORAGE
            localStorage.setItem('fireguild_user', JSON.stringify(currentUser));
            
            document.getElementById('displayName').textContent = userData.displayName;
            document.getElementById('userLogin').textContent = '@' + username;
            
            authScreen.style.display = 'none';
            mainApp.style.display = 'flex';
            
            loadData();
        };

        // –í—ã—Ö–æ–¥
        logoutBtn.onclick = () => {
            // üî• –£–î–ê–õ–Ø–ï–ú –ò–ó LOCALSTORAGE
            localStorage.removeItem('fireguild_user');
            currentUser = null;
            currentChat = null;
            authScreen.style.display = 'flex';
            mainApp.style.display = 'none';
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª—è –≤–≤–æ–¥–∞
            document.getElementById('loginUsername').value = '';
            document.getElementById('loginPassword').value = '';
        };

        // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
        function loadData() {
            if (!currentUser) return;
            
            // –°–ª—É—à–∞–µ–º –∑–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è
            const requestsRef = ref(db, `users/${currentUser.username}/friendRequests`);
            onValue(requestsRef, (snapshot) => {
                if (snapshot.exists()) {
                    showFriendRequests(snapshot.val());
                }
            });
            
            // –°–ª—É—à–∞–µ–º —á–∞—Ç—ã
            const chatsRef = ref(db, `users/${currentUser.username}/chats`);
            onValue(chatsRef, (snapshot) => {
                if (snapshot.exists()) {
                    displayChats(snapshot.val());
                } else {
                    chatsList.innerHTML = '<div style="color: #8696a0; text-align: center; padding: 20px;">–ù–µ—Ç —á–∞—Ç–æ–≤</div>';
                }
            });
            
            // –°–ª—É—à–∞–µ–º –¥—Ä—É–∑–µ–π
            const friendsRef = ref(db, `users/${currentUser.username}/friends`);
            onValue(friendsRef, (snapshot) => {
                if (snapshot.exists()) {
                    displayFriends(snapshot.val());
                } else {
                    friendsList.innerHTML = '<div style="color: #8696a0; text-align: center; padding: 20px;">–ù–µ—Ç –¥—Ä—É–∑–µ–π</div>';
                }
            });
        }

        // –ü–æ–∫–∞–∑ –∑–∞—è–≤–æ–∫
        function showFriendRequests(requests) {
            const requestsArray = Object.entries(requests);
            if (requestsArray.length === 0) return;
            
            let html = '<div style="padding: 10px; background: #2a3943; border-radius: 10px; margin: 10px;">';
            html += '<h4 style="color: white; margin-bottom: 10px;">üì® –ó–∞—è–≤–∫–∏ –≤ –¥—Ä—É–∑—å—è:</h4>';
            
            requestsArray.forEach(([from, data]) => {
                html += `
                    <div class="friend-request" id="request-${from}">
                        <span style="color: white;">@${from}</span>
                        <div>
                            <button onclick="acceptFriend('${from}')" style="background: #48bb78; border: none; color: white; padding: 5px 10px; border-radius: 5px; margin-right: 5px; cursor: pointer;">‚úì</button>
                            <button onclick="rejectFriend('${from}')" style="background: #f56565; border: none; color: white; padding: 5px 10px; border-radius: 5px; cursor: pointer;">‚úó</button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –∑–∞—è–≤–∫–∏ –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ
            const oldRequests = document.querySelectorAll('.friend-request');
            oldRequests.forEach(el => el.remove());
            
            friendsList.insertAdjacentHTML('afterbegin', html);
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        window.acceptFriend = async (from) => {
            const chatId = [currentUser.username, from].sort().join('_');
            
            await update(ref(db), {
                [`users/${currentUser.username}/friends/${from}`]: true,
                [`users/${from}/friends/${currentUser.username}`]: true,
                [`users/${currentUser.username}/chats/${chatId}`]: { with: from, lastMessage: '' },
                [`users/${from}/chats/${chatId}`]: { with: currentUser.username, lastMessage: '' },
                [`users/${currentUser.username}/friendRequests/${from}`]: null,
                [`users/${from}/friendRequests/${currentUser.username}`]: null
            });
        };

        window.rejectFriend = async (from) => {
            await remove(ref(db, `users/${currentUser.username}/friendRequests/${from}`));
        };

        // –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∞
        addFriendBtn.onclick = async () => {
            const friend = friendUsername.value.trim();
            if (!friend) return;
            
            if (friend === currentUser.username) {
                alert('–ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–±—è!');
                return;
            }
            
            const userRef = ref(db, `users/${friend}`);
            const snapshot = await get(userRef);
            
            if (!snapshot.exists()) {
                alert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –¥—Ä—É–∑—å—è –ª–∏ —É–∂–µ
            const friendsRef = ref(db, `users/${currentUser.username}/friends/${friend}`);
            const friendsSnap = await get(friendsRef);
            if (friendsSnap.exists()) {
                alert('–í—ã —É–∂–µ –¥—Ä—É–∑—å—è!');
                return;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞—è–≤–∫—É
            await set(ref(db, `users/${friend}/friendRequests/${currentUser.username}`), {
                from: currentUser.username,
                displayName: currentUser.displayName,
                timestamp: Date.now()
            });
            
            alert('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
            friendUsername.value = '';
        };

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–∞—Ç–æ–≤
        function displayChats(chats) {
            chatsList.innerHTML = '';
            Object.keys(chats).forEach(chatId => {
                const friend = chats[chatId].with;
                const div = document.createElement('div');
                div.className = `list-item ${currentChat?.id === chatId ? 'active' : ''}`;
                div.innerHTML = `
                    <div class="avatar">${friend.charAt(0).toUpperCase()}</div>
                    <div class="item-info">
                        <div class="item-name">@${friend}</div>
                        <div class="item-status">${chats[chatId].lastMessage || 'üïäÔ∏è –ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π'}</div>
                    </div>
                `;
                div.onclick = () => openChat(chatId, friend);
                chatsList.appendChild(div);
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥—Ä—É–∑–µ–π
        function displayFriends(friends) {
            friendsList.innerHTML = '';
            Object.keys(friends).forEach(friend => {
                const div = document.createElement('div');
                div.className = 'list-item';
                div.innerHTML = `
                    <div class="avatar">${friend.charAt(0).toUpperCase()}</div>
                    <div class="item-info">
                        <div class="item-name">@${friend}</div>
                        <div class="item-status"><span class="online-status"></span> –í —Å–µ—Ç–∏</div>
                    </div>
                `;
                div.onclick = () => {
                    const chatId = [currentUser.username, friend].sort().join('_');
                    openChat(chatId, friend);
                    chatsTab.click(); // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ –≤–∫–ª–∞–¥–∫—É —á–∞—Ç–æ–≤
                };
                friendsList.appendChild(div);
            });
        }

        // –û—Ç–∫—Ä—ã—Ç—å —á–∞—Ç
        function openChat(chatId, friend) {
            currentChat = { id: chatId, friend: friend };
            chatHeader.textContent = `@${friend}`;
            chatInput.style.display = 'flex';
            messagesDiv.innerHTML = '';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è
            const messagesRef = query(ref(db, `chats/${chatId}/messages`), orderByChild('timestamp'));
            onChildAdded(messagesRef, (snapshot) => {
                const msg = snapshot.val();
                displayMessage(msg, friend);
            });
        }

        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
        function displayMessage(msg, friend) {
            const isMine = msg.sender === currentUser.username;
            const div = document.createElement('div');
            div.className = `message ${isMine ? 'my-message' : 'other-message'}`;
            
            let content = '';
            if (msg.type === 'image') {
                content = `<img src="${msg.url}" class="message-image" onclick="showImage('${msg.url}')">`;
            } else {
                content = msg.text;
            }
            
            const time = new Date(msg.timestamp).toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            
            div.innerHTML = `
                <div class="message-info">
                    <span>${isMine ? '–í—ã' : '@' + friend}</span>
                    <span class="message-time">${time}</span>
                </div>
                ${content}
            `;
            
            messagesDiv.appendChild(div);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        sendBtn.onclick = sendMessage;
        messageInput.onkeypress = (e) => {
            if (e.key === 'Enter') sendMessage();
        };

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !currentChat) return;
            
            const messageData = {
                text: text,
                sender: currentUser.username,
                timestamp: Date.now(),
                type: 'text'
            };
            
            await push(ref(db, `chats/${currentChat.id}/messages`), messageData);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            const shortText = text.length > 30 ? text.substring(0, 30) + '...' : text;
            await update(ref(db), {
                [`users/${currentUser.username}/chats/${currentChat.id}/lastMessage`]: shortText,
                [`users/${currentChat.friend}/chats/${currentChat.id}/lastMessage`]: shortText
            });
            
            messageInput.value = '';
        }

        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–∞—Ä—Ç–∏–Ω–∫–∏
        imageBtn.onclick = () => imageInput.click();
        
        imageInput.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file || !currentChat) return;
            
            try {
                const imageRef = storageRef(storage, `chats/${currentChat.id}/${Date.now()}_${file.name}`);
                await uploadBytes(imageRef, file);
                const url = await getDownloadURL(imageRef);
                
                await push(ref(db, `chats/${currentChat.id}/messages`), {
                    url: url,
                    sender: currentUser.username,
                    timestamp: Date.now(),
                    type: 'image'
                });
                
                await update(ref(db), {
                    [`users/${currentUser.username}/chats/${currentChat.id}/lastMessage`]: 'üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ',
                    [`users/${currentChat.friend}/chats/${currentChat.id}/lastMessage`]: 'üì∑ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ'
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è');
            }
        };

        // –ü–æ–∫–∞–∑ –∫–∞—Ä—Ç–∏–Ω–∫–∏
        window.showImage = (url) => {
            modalImage.src = url;
            imageModal.style.display = 'flex';
        };
        
        closeModal.onclick = () => {
            imageModal.style.display = 'none';
        };
        
        window.onclick = (e) => {
            if (e.target === imageModal) {
                imageModal.style.display = 'none';
            }
        };

        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∞–±–æ–≤
        chatsTab.onclick = () => {
            chatsTab.classList.add('active');
            friendsTab.classList.remove('active');
            chatsList.style.display = 'block';
            friendsList.style.display = 'none';
        };
        
        friendsTab.onclick = () => {
            friendsTab.classList.add('active');
            chatsTab.classList.remove('active');
            friendsList.style.display = 'block';
            chatsList.style.display = 'none';
        };
    </script>
</body>
</html>